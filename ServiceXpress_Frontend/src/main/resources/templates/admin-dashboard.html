<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard</title>
    <!-- Use only Bootstrap 5.3.3 to avoid conflicts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/admincss.css}">
</head>
<body>
<div class="container">
    <h2>Admin Dashboard</h2>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
    <div th:replace="fragments/adminNavbar :: navbar"></div>

    <!-- Debug Output -->
    <div class="alert alert-info">
        <p>Debug - Dashboard Data: <span th:text="${dashboardData}"></span></p>
        <p>Debug - Vehicles Due: <span th:text="${dashboardData.vehiclesDue}"></span></p>
        <p>Debug - Vehicles Under Service: <span th:text="${dashboardData.vehiclesUnderService}"></span></p>
        <p>Debug - Vehicles Completed: <span th:text="${dashboardData.vehiclesCompleted}"></span></p>
        <p>Debug - Available Advisors: <span th:text="${dashboardData.availableAdvisors}"></span></p>
    </div>

    <!-- Vehicles Due -->
    <div class="table-container mt-4">
        <h4>Vehicles Due</h4>
        <div class="alert alert-warning">
            <p>Debug - Is dashboardData null? <span th:text="${dashboardData == null}"></span></p>
            <p>Debug - Is vehiclesDue null? <span th:text="${dashboardData != null and dashboardData.vehiclesDue == null}"></span></p>
            <p>Debug - Vehicles Due size: <span th:text="${dashboardData != null and dashboardData.vehiclesDue != null} ? ${dashboardData.vehiclesDue.size()} : 'N/A'"></span></p>
        </div>
        <table id="vehiclesDueTable" class="table table-responsive table-striped table-hover">
    <thead>
    <tr>
        <th>Customer Name</th>
        <th>Vehicle Type</th>
        <th>Vehicle Model</th>
        <th>Service Center</th>
        <th>Services</th>
        <th>Requested Date</th>
        <th>Status</th>
        <th>Assign Advisor</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="v : ${dashboardData.vehiclesDue}">
        <td th:text="${v.customerName}"></td>
        <td th:text="${v.vehicleType}"></td>
        <td th:text="${v.vehicleModel}"></td>
        <td th:text="${v.serviceCenter}"></td>
        <td th:text="${v.services}"></td>
        <td th:text="${v.requestedDate}"></td>
        <td th:text="${v.status}"></td>
        <td>
            <select th:id="'advisor-' + ${v.id}">
                <option value="">Select Advisor</option>
                <option th:each="advisor : ${dashboardData.availableAdvisors}"
                        th:value="${advisor.username}"
                        th:text="${advisor.username}"
                        th:if="${advisor.centerName == v.serviceCenter}"></option>
            </select>
            <button class="btn btn-sm btn-primary" th:onclick="'assignAdvisor(' + ${v.id} + ')'">Assign</button>
        </td>
    </tr>
    <tr th:if="${dashboardData == null or dashboardData.vehiclesDue == null or dashboardData.vehiclesDue.size() == 0}">
        <td>No vehicles due at this time.</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    </tbody>
</table>
    </div>

    <!-- Vehicles Under Service -->
    <div class="table-container mt-4">
        <h4>Vehicles Under Service</h4>
        <div class="alert alert-warning">
            <p>Debug - Is vehiclesUnderService null? <span th:text="${dashboardData != null and dashboardData.vehiclesUnderService == null}"></span></p>
            <p>Debug - Vehicles Under Service size: <span th:text="${dashboardData != null and dashboardData.vehiclesUnderService != null} ? ${dashboardData.vehiclesUnderService.size()} : 'N/A'"></span></p>
        </div>
        <table id="vehiclesUnderServiceTable" class="table table-responsive table-striped table-hover">
    <thead>
    <tr>
        <th>Customer Name</th>
        <th>Vehicle Type</th>
        <th>Vehicle Model</th>
        <th>Service Center</th>
        <th>Service Advisor</th>
        <th>Services</th>
        <th>Status</th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="v : ${dashboardData.vehiclesUnderService}">
        <td th:text="${v.customerName}"></td>
        <td th:text="${v.vehicleType}"></td>
        <td th:text="${v.vehicleModel}"></td>
        <td th:text="${v.serviceCenter}"></td>
        <td th:text="${v.serviceAdvisor}"></td>
        <td th:text="${v.services}"></td>
        <td th:text="${v.status}"></td>
        <td>
            <button class="btn btn-sm btn-success" th:onclick="'completeBooking(' + ${v.id} + ')'" th:disabled="${#authentication.getPrincipal().authorities.contains('ROLE_ADMIN')}">Complete</button>
        </td>
    </tr>
    <tr th:if="${dashboardData == null or dashboardData.vehiclesUnderService == null or dashboardData.vehiclesUnderService.size() == 0}">
        <td>No vehicles under service at this time.</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    </tbody>
</table>
    </div>

    <!-- Vehicles Completed -->
    <div class="table-container mt-4">
        <h4>Completed Services</h4>
        <div class="alert alert-warning">
            <p>Debug - Is vehiclesCompleted null? <span th:text="${dashboardData != null and dashboardData.vehiclesCompleted == null}"></span></p>
            <p>Debug - Vehicles Completed size: <span th:text="${dashboardData != null and dashboardData.vehiclesCompleted != null} ? ${dashboardData.vehiclesCompleted.size()} : 'N/A'"></span></p>
        </div>
       <table id="vehiclesCompletedTable" class="table table-responsive table-striped table-hover">
    <thead>
    <tr>
        <th>Customer Name</th>
        <th>Vehicle Type</th>
        <th>Vehicle Model</th>
        <th>Service Center</th>
        <th>Service Advisor</th>
        <th>Services</th>
        <th>Completed Date</th>
        <th>Bill of Materials</th>
        <th>Status</th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="v : ${dashboardData.vehiclesCompleted}">
        <td th:text="${v.customerName}"></td>
        <td th:text="${v.vehicleType}"></td>
        <td th:text="${v.vehicleModel}"></td>
        <td th:text="${v.serviceCenter}"></td>
        <td th:text="${v.serviceAdvisor}"></td>
        <td th:text="${v.services}"></td>
        <td th:text="${v.completedDate}"></td>
        <td th:text="${v.billOfMaterials}"></td>
        <td th:text="${v.status}"></td>
        <td>
            <div th:if="${v.paymentRequested == false}">
                <button class="btn btn-sm btn-warning" disabled>Payment Request</button>
            </div>
            <div th:if="${v.paymentRequested and !v.paymentReceived}">
                <span class="badge bg-info text-dark">Waiting for Payment</span>
            </div>
            <div th:if="${v.paymentReceived}">
                <button class="btn btn-sm btn-success" disabled>Dispatch</button>
            </div>
        </td>
    </tr>
    <tr th:if="${dashboardData == null or dashboardData.vehiclesCompleted == null or dashboardData.vehiclesCompleted.size() == 0}">
        <td>No completed services at this time.</td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    </tbody>
</table>
    </div>
</div>
<div th:replace="fragments/footer :: footer"></div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // JavaScript functions for assigning advisors and completing bookings
    function assignAdvisor(bookingId) {
        var advisorUsername = document.getElementById('advisor-' + bookingId).value;
        if (!advisorUsername) {
            alert('Please select an advisor');
            return;
        }
        fetch('http://localhost:8081/bookings/' + bookingId + '/assign-advisor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': 'Bearer ' + '[[${token}]]'
            },
            body: 'advisorUsername=' + encodeURIComponent(advisorUsername)
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                response.text().then(text => alert('Failed to assign advisor: ' + text));
            }
        }).catch(error => {
            alert('Error assigning advisor: ' + error.message);
        });
    }

    function completeBooking(bookingId) {
        var billOfMaterials = prompt('Enter Bill of Materials:');
        if (!billOfMaterials) {
            alert('Bill of Materials is required');
            return;
        }
        fetch('http://localhost:8081/bookings/' + bookingId + '/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': 'Bearer ' + '[[${token}]]'
            },
            body: 'billOfMaterials=' + encodeURIComponent(billOfMaterials)
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                response.text().then(text => alert('Failed to complete booking: ' + text));
            }
        }).catch(error => {
            alert('Error completing booking: ' + error.message);
        });
    }

    // Initialize DataTables after the page is fully loaded
    window.addEventListener('load', function() {
        try {
            // Initialize each table individually with unique IDs
            $('#vehiclesDueTable').DataTable({
                "paging": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "language": {
                    "emptyTable": "No data available in table"
                }
            });

            $('#vehiclesUnderServiceTable').DataTable({
                "paging": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "language": {
                    "emptyTable": "No data available in table"
                }
            });

            $('#vehiclesCompletedTable').DataTable({
                "paging": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "language": {
                    "emptyTable": "No data available in table"
                }
            });
        } catch (e) {
            console.error("Error initializing DataTables:", e);
        }
    });
</script>
</body>
</html>